


<!doctype html>
<!--
      Think this site is hideous? We could use your help!
      More info at http://www.ocf.berkeley.edu/about/staff :-)

      This is ocfweb version 2396812250bda83100753749b8a6a3fa0a0f64d9
      https://github.com/ocf/ocfweb/
-->
<html class="page-doc page-doc-staff-procedures-new-host">


    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        

        
        
            <meta property="og:image" content="https://static.ocf.berkeley.edu/img/penguin-opengraph.png"/>
        

        <link rel="canonical" href="https://www.ocf.berkeley.edu/docs/staff/procedures/new-host/" />

        <title>
            
                
                    Creating new hosts (servers, desktops) &ndash;
                
                Open Computing Facility
            
        </title>

        <link href="https://fonts.googleapis.com/css?family=Roboto:400,700,400italic,700italic,500,500italic" rel="stylesheet">
        <link href="https://static.ocf.berkeley.edu/scss/site.scss.css" rel="stylesheet" />
        <link rel="icon" href="https://static.ocf.berkeley.edu/img/favicon/favicon-16.png" sizes="16x16" />
        <link rel="icon" href="https://static.ocf.berkeley.edu/img/favicon/favicon-32.png" sizes="32x32" />
    </head>


    <body>
        <div class="navbar ocf-navbar navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">Open Computing Facility</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li class="hidden-sm"><a href="/account/register/">Join</a></li>
                        <li class="dropdown">
                            <a href="/docs/about/" class="dropdown-toggle" data-toggle="dropdown">
                                About <span class="hidden-sm">Us</span> <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu" role="menu">
                                <li><a href="/docs/about/">Our Organization</a></li>
                                <li><a href="/about/staff">Joining the Staff Team</a></li>
                                <li><a href="/stats/">Lab Statistics</a></li>
                                <li><a href="/docs/staff/backend/">Backend Infrastructure</a></li>
                            </ul>
                        </li>

                        <li class="dropdown">
                            <a href="/docs/services/" class="dropdown-toggle" data-toggle="dropdown">
                                Services <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu" role="menu">
                                <li><a href="/docs/services/lab/">Computer Lab</a></li>
                                <li><a href="/docs/services/lab/printing/">Printing</a></li>
                                <li><a href="/docs/services/web/">Web Hosting</a></li>
                                <li><a href="/docs/services/webapps/">Application Hosting</a></li>
                                <li><a href="/docs/services/shell/">SSH/SFTP (Shell)</a></li>
                                <li><a href="/docs/services/mail/">Email Hosting</a></li>
                                <li><a href="/docs/services/mysql/">MySQL Database</a></li>
                                <li><a href="/docs/services/mirrors/">Software Mirrors</a></li>
                                <li><a href="/docs/services/hpc/">High Performance Computing</a></li>
                            </ul>
                        </li>

                        <li><a href="/staff-hours">Staff Hours</a></li>
                        <li><a href="/docs/">Help</a></li>
                        <li><a href="/docs/contact/">
                                Contact <span class="hidden-sm">Us</span>
                        </a></li>

                        
                            <li>
                                <a href="/login/login/?next=/docs/staff/procedures/new-host/" class="ocf-account-dropdown">
                                    <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                                    Log In
                                </a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>

        <!-- <div class="ocf-status-bar">
            <div class="container">
                <p>
                    
                        
                            <strong>Lab Currently Closed</strong>
                        
                        <span class="nowrap">
                            
                                Hours:
                            
                            9amâ€“8pm
                            on Monday 
                            <a class="subtle" href="/docs/services/lab/">more &raquo;</a>
                        </span>
                    
                </p>
            </div>
        </div> -->

        
            
                <div class="ocf-hero ocf-page-title">
                    <div class="container">
                        <h1>Creating new hosts (servers, desktops)</div>
                    </div>
                </div>
            
        

        
        <div class="ocf-content container">
            
                
            
            
<div class="row">
    <div class="col-sm-8 ocf-content-block">
        
          
<div class="dummy">
  <div class="ocf-doc-toc">
    
        <a data-toggle="collapse" data-target="#toc" class="doc-collapse-toggle collapsed">
          <span class="glyphicon" aria-hidden="true"></span>
          Table of Contents
        </a>
        <div id="toc" class="collapse">
          <ol><li><a href="#h2_step-0-pick-a-hostname-and-ip">Step 0. Pick a hostname and IP</a></li><li><a href="#h2_step-1-new-hosts-only-add-to-ldap-dns-puppet-kerberos">Step 1. (New hosts only) Add to LDAP, DNS, Puppet, Kerberos</a></li><ol><li><a href="#h3_step-11-add-the-ldap-entry">Step 1.1. Add the LDAP entry</a></li><li><a href="#h3_step-12-add-the-dns-record">Step 1.2. Add the DNS record</a></li><li><a href="#h3_step-13-add-node-config-to-puppet">Step 1.3. Add node config to Puppet</a></li><li><a href="#h3_step-14-create-the-kerberos-keytab">Step 1.4. Create the Kerberos keytab</a></li></ol><li><a href="#h2_step-2-create-the-host-run-debian-installer">Step 2. Create the host, run Debian installer</a></li><ol><li><a href="#h3_virtual-hosts">Virtual hosts</a></li><li><a href="#h3_physical-hosts">Physical hosts</a></li></ol><li><a href="#h2_step-3-log-in-and-start-puppet">Step 3. Log in and start Puppet</a></li><ol><li><a href="#h3_virtual-hosts_">Virtual hosts</a></li><li><a href="#h3_physical-hosts_">Physical hosts</a></li></ol><li><a href="#h2_step-4-sign-the-puppet-cert-and-run-puppet">Step 4. Sign the Puppet cert and run Puppet</a></li><ol><li><a href="#h3_step-41-upgrade-packages">Step 4.1. Upgrade packages</a></li></ol></ol>
        </div>
    
  </div>
</div>


        
        <p>Bringing up new hosts is pretty easy, but has a few easy-to-miss steps. This
process requires both root and a <code>/admin</code> principal.</p>
<p>It's preferable to not bring up servers at a whim, but if you must, you should
use hostnames of the form <code>hozer-{60..89}</code> and their corresponding IP addresses
(rather than allocating new ones). Please clean up when you're finished by
running <code>virsh undefine hozer-{num}</code> to remove the VM and <code>lvremove
/dev/vg/hozer-{num}</code> to remove the logical volume.</p>
<h2 id="h2_step-0-pick-a-hostname-and-ip">Step 0. Pick a hostname and IP <a class="anchor" href="#h2_step-0-pick-a-hostname-and-ip"><span></span></a></h2>
<p>If you are creating a brand-new host, you can find a list of IP addresses
already in use in our <a href="https://github.com/ocf/dns/blob/master/etc/zones/db.226.229.169.in-addr.arpa">DNS repo on GitHub</a>. There is also <a href="https://ocf.io/s/ips">a
spreadsheet of currently used IPs</a> containing more information,
although this may not always be up to date. Hostnames must be based on
(un)natural disasters; check out <code>~staff/server_name_ideas</code> if you're having
trouble thinking of one.</p>
<h2 id="h2_step-1-new-hosts-only-add-to-ldap-dns-puppet-kerberos">Step 1. (New hosts only) Add to LDAP, DNS, Puppet, Kerberos <a class="anchor" href="#h2_step-1-new-hosts-only-add-to-ldap-dns-puppet-kerberos"><span></span></a></h2>
<p>Only do these if a server with this hostname has never existed before (or if
it's been long enough that some of these steps have never been done before).
Unfortunately, these steps tend to change a lot as our infrastructure evolves.</p>
<h3 id="h3_step-11-add-the-ldap-entry">Step 1.1. Add the LDAP entry <a class="anchor" href="#h3_step-11-add-the-ldap-entry"><span></span></a></h3>
<p>On supernova, <code>kinit $USER/admin ldap-add-host &lt;hostname&gt; &lt;ip-last-octet&gt;</code>.
<code>&lt;ip-last-octet&gt;</code> is the part after the last <code>.</code> in the IP address, like <code>42</code>
for the address <code>169.229.226.42</code>. If setting up a desktop, add a final argument
<code>desktop</code>, which will set the <code>type</code> to <code>desktop</code>. If doing a staff VM, add to
<code>staffvm</code> instead.</p>
<h3 id="h3_step-12-add-the-dns-record">Step 1.2. Add the DNS record <a class="anchor" href="#h3_step-12-add-the-dns-record"><span></span></a></h3>
<p>Clone the <a href="https://github.com/ocf/dns">DNS repo</a> from GitHub, run <code>make</code>, and push a commit
with the new records.</p>
<h3 id="h3_step-13-add-node-config-to-puppet">Step 1.3. Add node config to Puppet <a class="anchor" href="#h3_step-13-add-node-config-to-puppet"><span></span></a></h3>
<p>Only do this if you are creating a staff VM, a server which will run a service,
or a special snowflake. Make a commit to the <a href="https://github.com/ocf/puppet">Puppet repo</a> which
adds a file <code>hieradata/nodes/&lt;hostname&gt;.yaml</code> for the new host. Follow the
example of a similar node's <code>host.yaml</code> file.</p>
<h3 id="h3_step-14-create-the-kerberos-keytab">Step 1.4. Create the Kerberos keytab <a class="anchor" href="#h3_step-14-create-the-kerberos-keytab"><span></span></a></h3>
<p>On the puppetmaster, run <code>sudo gen-keytab</code>.</p>
<h2 id="h2_step-2-create-the-host-run-debian-installer">Step 2. Create the host, run Debian installer <a class="anchor" href="#h2_step-2-create-the-host-run-debian-installer"><span></span></a></h2>
<h3 id="h3_virtual-hosts">Virtual hosts <a class="anchor" href="#h3_virtual-hosts"><span></span></a></h3>
<p>We have a handy script, <code>makevm</code>, that:</p>
<ul>
<li>Creates a logical volume (disk) for the new VM</li>
<li>Adds a new VM using virt-install and PXE boots it</li>
<li>Waits for the Debian installer to finish</li>
<li>SSHs to the new server and sets its IP</li>
</ul>
<p>To use it, log on to the target physical server (<code>riptide</code>, <code>hal</code>, <code>pandemic</code>, or <code>jaws</code>),
and run <code>makevm --help</code>. A typical invocation looks something like:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span>makevm -m 4096 -c 2 -s 15 arsenic 169.229.226.47
</pre></div>
<h3 id="h3_physical-hosts">Physical hosts <a class="anchor" href="#h3_physical-hosts"><span></span></a></h3>
<p>All you need to do to run the Debian installer is PXE boot. On desktops, you
sometimes need to enable this in the BIOS before you can select it from the
boot menu.</p>
<p>Be warned that the default action (automated install) happens after 5 seconds.
So don't PXE-boot your laptop and walk away!</p>
<p>We preseed a bunch of settings (random questions, mirror locations, packages,
etc.). The install should be completely hands-free, and will restart to a login
tty.</p>
<h2 id="h2_step-3-log-in-and-start-puppet">Step 3. Log in and start Puppet <a class="anchor" href="#h2_step-3-log-in-and-start-puppet"><span></span></a></h2>
<h3 id="h3_virtual-hosts_">Virtual hosts <a class="anchor" href="#h3_virtual-hosts_"><span></span></a></h3>
<p>The <code>makevm</code> script at the very end drops you into a shell. In this shell, you
should run:</p>
<ol>
<li><code>puppet agent --test</code>.</li>
</ol>
<h3 id="h3_physical-hosts_">Physical hosts <a class="anchor" href="#h3_physical-hosts_"><span></span></a></h3>
<ol>
<li>Log in as <code>root:r00tme</code>. You can change the password if you want, but don't
have to (Puppet will change it soon anyway).</li>
<li><p>Make sure the IP address and hostname is set correctly. This may have
happened by DHCP if it's a desktop, but if not, fix it and restart:</p>
<ol>
<li>Edit <code>/etc/hostname</code> so it has the desired hostname instead of
dhcp-<em>whatever</em>.</li>
<li>Run <code>hostname -F /etc/hostname</code>.</li>
<li>Find out what the ethernet interface's name and current IP address is
by running <code>ip addr</code>. The ethernet interface should be named something
like <code>eno1</code> or <code>enp4s2</code>. (In the following instructions, substitute
<code>eno1</code> with the correct name.)</li>
<li>Remove the incorrect IP addresses with <code>ip addr del $WRONG_ADDRESS
dev eno1</code>.</li>
<li>Add the correct IP addresses with <code>ip addr add $CORRECT_ADDRESS
dev eno1</code>. Make sure that $CORRECT_ADDRESS includes the netmask.</li>
</ol>
</li>
<li><p><code>puppet agent --test</code></p>
</li>
</ol>
<h2 id="h2_step-4-sign-the-puppet-cert-and-run-puppet">Step 4. Sign the Puppet cert and run Puppet <a class="anchor" href="#h2_step-4-sign-the-puppet-cert-and-run-puppet"><span></span></a></h2>
<p>On the puppetmaster, <code>sudo puppetserver ca list</code> to see pending requests. When
you see yours, use <code>sudo puppetserver ca sign --certname hostname.ocf.berkeley.edu</code>.</p>
<p>Log back into the host and run <code>puppet agent --test</code> to start the Puppet
run. You may need to repeat this once or twice until the run converges.</p>
<h3 id="h3_step-41-upgrade-packages">Step 4.1. Upgrade packages <a class="anchor" href="#h3_step-41-upgrade-packages"><span></span></a></h3>
<p>The first Puppet run and various other things may be broken if one or more
packages are out of date, e.g. Puppet. Remedy this with an <code>apt update &amp;&amp;
apt upgrade</code>.</p>

        
    </div>

    <div class="col-sm-4 ocf-sidebar">
        
            <p class="page-github-icons">
                <a class="edit-this-page" href="https://github.com/ocf/ocfweb/edit/master/ocfweb/docs/docs/staff/procedures/new-host.md">
                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    Edit this Page
                </a>
                <a class="page-history" href="https://github.com/ocf/ocfweb/commits/master/ocfweb/docs/docs/staff/procedures/new-host.md">
                    <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                    Page History
                </a>
            </p>
            
<div class="dummy">
  <div class="ocf-doc-toc">
    
        <h3>Table of Contents</h3>
        <ol><li><a href="#h2_step-0-pick-a-hostname-and-ip">Step 0. Pick a hostname and IP</a></li><li><a href="#h2_step-1-new-hosts-only-add-to-ldap-dns-puppet-kerberos">Step 1. (New hosts only) Add to LDAP, DNS, Puppet, Kerberos</a></li><ol><li><a href="#h3_step-11-add-the-ldap-entry">Step 1.1. Add the LDAP entry</a></li><li><a href="#h3_step-12-add-the-dns-record">Step 1.2. Add the DNS record</a></li><li><a href="#h3_step-13-add-node-config-to-puppet">Step 1.3. Add node config to Puppet</a></li><li><a href="#h3_step-14-create-the-kerberos-keytab">Step 1.4. Create the Kerberos keytab</a></li></ol><li><a href="#h2_step-2-create-the-host-run-debian-installer">Step 2. Create the host, run Debian installer</a></li><ol><li><a href="#h3_virtual-hosts">Virtual hosts</a></li><li><a href="#h3_physical-hosts">Physical hosts</a></li></ol><li><a href="#h2_step-3-log-in-and-start-puppet">Step 3. Log in and start Puppet</a></li><ol><li><a href="#h3_virtual-hosts_">Virtual hosts</a></li><li><a href="#h3_physical-hosts_">Physical hosts</a></li></ol><li><a href="#h2_step-4-sign-the-puppet-cert-and-run-puppet">Step 4. Sign the Puppet cert and run Puppet</a></li><ol><li><a href="#h3_step-41-upgrade-packages">Step 4.1. Upgrade packages</a></li></ol></ol>
    
  </div>
</div>



            <h3>More in this category</h3>
            


    <li>
        
            <a href="/docs/staff/procedures/">Procedures</a>
        


<ul>
    
        


    <li>
        
            <a href="/docs/staff/procedures/accounts/">Accounts</a>
        


<ul>
    
        


    <li>
        
            <a href="/docs/staff/procedures/accounts/alumni-reset/">Alumni account reset</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/accounts/association/">LDAP association</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/accounts/renaming/">Rename an account</a>
        


<ul>
    
</ul>


    </li>


    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/hpc/">Adding users to the HPC cluster</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/backporting-packages/">Backporting Debian packages</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/vhost/">Configuring virtual hosting</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <strong>Creating new hosts (servers, desktops)</strong>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/dmca/">DMCA</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/editing-docs/">Editing docs</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/granting-privileges/">Granting staff privileges</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/installing-updates/">Installing updates with apt-dater</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/live-resize/">Live disk resizing</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/gapps/">Making OCF Google Apps accounts</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/xmpp/">Manually creating XMPP accounts</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/printing/">Printing maintenance</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/process-accounting/">Process accounting</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/restarting-services/">Restarting services</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/ssh-supernova/">SSHing into Supernova</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/ssl/">SSL certificates</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/setting-up-lacp/">Setting up bridging and link aggregation</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/setting-up-mdraid/">Setting up mdraid on servers</a>
        


<ul>
    
</ul>


    </li>


    
        


    <li>
        
            <a href="/docs/staff/procedures/user-quotas/">User disk quotas</a>
        


<ul>
    
</ul>


    </li>


    
</ul>


    </li>



        
    </div>
</div>

        </div>
        

        
            <div class="footer ocf-footer">
                
                    <div class="ocf-footer-top">
                        <div class="container">
                            <p class="text-center">OCF &hearts;
                            <a href="https://www.linuxfoundation.org/">Linux</a>,
                            <a href="https://kubernetes.io/">Kubernetes</a>,
                            <a href="https://www.python.org/">Python</a>,
                            <a href="https://nixos.org/">Nix</a>,
                            and Free/Open-Source Software. <span class="nowrap">Sound like you?
                            <a href="/about/staff">Join the staff team!</a></span></p>
                        </div>
                    </div>
                

                <div class="container">
                    <div class="row">
                        <div class="col-sm-3">
                            <h5>About the OCF</h5>
                            <ul class="list-unstyled">
                                <li><a href="/docs/about/">Overview</a></li>
                                <li><a href="/docs/about/officers/">Officers</a></li>
                                <li><a href="/docs/docs/">Official Documents</a></li>
                                <li><a href="https://www.ocf.berkeley.edu/~staff/bod/">Board Meeting Minutes</a></li>
                                <li><a href="/docs/privacy/">Privacy Policy</a></li>
                            </ul>
                        </div>

                        <div class="col-sm-3">
                            <h5>Account Tools</h5>
                            <ul class="list-unstyled">
                                <li><a href="/account/register/">Join the OCF</a></li>
                                <li><a href="/account/password/">Reset Password</a></li>
                                <li><a href="/account/commands/">Manage My Account</a></li>
                            </ul>
                        </div>

                        <div class="col-sm-3">
                            <h5>Services</h5>
                            <ul class="list-unstyled">
                                <li><a href="/docs/services/lab/">Computer Lab &amp; Printing</a></li>
                                <li><a href="/docs/services/web/">Web Hosting</a></li>
                <li><a href="/docs/services/webapps/">Application Hosting</a></li>
                                <li><a href="/docs/services/mail/">Email Hosting</a></li>
                                <li><a href="/docs/services/shell/">SSH/Remote Shell</a></li>
                <li><a href="/docs/services/hpc/">High Performance Computing</a></li>
                            </ul>
                        </div>

                        <div class="col-sm-3">
                            <h5>Help and Support</h5>
                            <ul class="list-unstyled">
                                <li><a href="https://status.ocf.berkeley.edu/">Status Blog</a></li>
                                <li><a href="https://ocf.io/donate">Donate to the OCF</a></li>
                                <li><a href="/docs/faq/">Frequently Asked Questions</a></li>
                                <li><a href="/docs/">User Documentation</a></li>
                                <li><a href="/docs/staff/">Staff Documentation</a></li>
                                <li><a href="/docs/contact/">Contact Us</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="ocf-copyright">
                        <p>The Open Computing Facility is run entirely by student volunteers.</p>
                        <p>Copyright &copy; 1989&ndash;2025 Board of Directors of the Open Computing Facility.</p>
                        <p>The Open Computing Facility is a Chartered Program of the ASUC.</p>
                    </div>
                </div>
            </div>
        

        <!-- Block intended to be overidden later for stuff like modals that should be under <body> -->
        

        <!-- Hack to make browsers load glyphicons immediately.

             Without this, there is awkward flashing on some pages (e.g. docs)
             when hovering over something and a glyphicon appears.
        -->
        <span style="font-family: 'Glyphicons Halflings';"></span>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://static.ocf.berkeley.edu/js/site.js"></script>

        
    </body>
</html>
